<!doctype html>
<html>

<style>

.highlighted{
  display: block; pointer-events: all; background-color: lightgreen;
}

.not-highlighted{
  display:block;pointer-events:none;background-color: gray;
}

</style>
<head>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

</head>

<body>

<div id="template-p" style="display:none">

  <form id="pwdform" action="password.html" method="post" target="pwdwindow">
    <input type="button" disabled="" value="MODE" onclick="poppwdwindow('pwdform');">
    <input type="button" disabled="" value="Next" onclick="nextstep()">
    <input type="hidden" name="system" id="system" value="Shopping">
    <input type="hidden" name="user" id="user" value="svp525941">
    <input type="hidden" name="mode" id="mode" value="enter">
    <input type="hidden" name="scheme" id="scheme" value="textrandom">
    <input type="hidden" name="condition" id="condition" value="az09-5">
    <input type="hidden" name="event" id="event" value="">
    <input type="hidden" name="data" id="data" value="">
    <input type="hidden" name="password" id="password" value="">
    <input type="hidden" name="reference" id="reference" value="">
    <input type="hidden" name="count" id="count" value="0">
  </form>
</div>

<div id="greeting"><h2> Password Tester</h2> <h3> User: <span id='userid'>Test</span></h3> <h3> Scheme: Name of our scheme</h3><hr></div>

<div id="svpcEmail" style="display: block; pointer-events: all; background-color: lightgreen;">Create Password for: <b>Email</b>

    <input type="button" data-system="Email" value="Create" id="cEmail" data-password="" onclick="poppwdwindow('cEmail', this);">
    <input type="button" value="Next" onclick="nextstep(this)">

</div><div id="svpcBanking" style="display:block;pointer-events:none;background-color: gray;">Create Password for: <b>Banking</b>

    <input type="button" data-system="Banking" disabled="" id="cBanking"  data-password="" value="Create" onclick="poppwdwindow('cBanking', this);">
    <input type="button" disabled="" value="Next" onclick="nextstep(this)">

</div><div id="svpcShopping" style="display:block;pointer-events:none;background-color: gray;">Create Password for: <b>Shopping</b>

    <input type="button" data-system="Shopping" disabled="" id="cShopping"  data-password="" value="Create" onclick="poppwdwindow('cShopping', this);">
    <input type="button" disabled="" value="Next" onclick="nextstep(this)">

</div>

<div><hr></div>

<div id="randomizeDiv">

</div>

<div id="logdiv">

<hr>
<div id="logheader" style="display:none">
<h3>Show Activity Log:
    <input type="button" value="Show" onclick="document.getElementById('log').style.display = 'block';">
    <input type="button" value="Hide" onclick="document.getElementById('log').style.display = 'none';">
</h3>
</div>

<div id="log" style="display: block; pointer-events: all; background-color: lightgray;">
<h4>Log Data:</h4>
<hr>
</div>


<script>

var randomFixedInteger = function (length) {
    return Math.floor(Math.pow(10, length-1) + Math.random() * (Math.pow(10, length) - Math.pow(10, length-1) - 1));
}


function generate_random_string(string_length){
    let random_string = '';
    let random_ascii;
    for(let i = 0; i < string_length; i++) {
        random_ascii = Math.floor((Math.random() * 25) + 97);
        random_string += String.fromCharCode(random_ascii)
    }
    return random_string
}

// var lastform = "";

var lastform = {
  event: "",
  eData: "",
  system: ""
}

greet = document.getElementById("greeting");
var user = generate_random_string(5) + randomFixedInteger(3);
// do random user
$('#userid').text(user);

csys = ["Email","Banking","Shopping"];

newdiv = document.createElement('div');
newdiv.innerHTML = "<HR>";
document.body.appendChild(newdiv);

esys = shuffle(csys)
for (x of esys)
mkenter(x);


document.body.appendChild(document.getElementById("logdiv"));

steps = $('div[id^="svp"]');
stepn = -1;
nextstep();


function mkenter(name) {

  newdiv = document.createElement('div');
  dname = "form"+"e"+name;
  newdiv.setAttribute("id", "svpe" + name);
  newdiv.setAttribute("class", "not-highlighted");

  var htmlString = '<input type="button" data-system="'+name+'" disabled="" id="e'+name+'" data-times="0" data-password="" value="Enter" onclick="poppwdwindow(\'e'+name+'\', this);">'+
    '<input type="button" disabled="" value="Next" onclick="nextstep(this)">';
  // pf = document.getElementById('template-p').innerHTML;


  newdiv.innerHTML = "Enter Password for: <B>" + name + "</B> (3 Attempts Allowed)" + htmlString;
  document.getElementById("randomizeDiv").appendChild(newdiv);
}

var globalPassword;
var openedWindow;
function createPassword(formid){
  var type = formid.substring(1,);
  // window.open('/password','Enter Password','left=20,top=20,width=320,height=480,toolbar=0,location=0,resizable=1');
  openedWindow = window.open('/passwordShape?create=true&type='+type,'Create Password','left=20,top=20,width=500,height=550,toolbar=0,location=0,resizable=1');



  openedWindow.addEventListener("beforeunload", function (e) {

    if (openedWindow.passwordAccept){
      $("#"+formid).attr('data-password',openedWindow.password);
      logit('Create');
    }
  });
}


function enterPassword(formid){
  var type = formid.substring(1,);
  openedWindow = window.open('/passwordShape?enter=true&type='+type,'Enter Password','left=20,top=20,width=500,height=500,toolbar=0,location=0,resizable=1');


  var d = new Date();
  var n = d.toISOString();

  var csvString = n + ',' + user + ',' + lastform.system + ',' + "Start entering password" + ','+ "start" + "\n";

  writeAction(csvString);
  var div = document.getElementById('log');

  newline = "<li>" + n + " || " + // date
  user +  " || " + // user
  lastform.system +  " || " + // which account
  "Start entering password" + " || " + // which event
  "start" +  " || "; // data
  div.innerHTML += newline;

 
  //

  openedWindow.addEventListener("beforeunload", function (e) {
    if (openedWindow.passwordAccept){
      $("#"+formid).attr('data-password',openedWindow.password);
      lastform.event=openedWindow.eventType;
      logit('Login');
    }
  });

}





function poppwdwindow(formid, el) {
  f= $(el).val();
  // console.log('check value', f);

  if (f == "Create") {

        lastform.event="Create account"

        createPassword(formid);
  } else if (f == "Enter"){
    // data attribute for password
    var count = parseInt($("#"+formid).attr('data-times')) + 1;
    // console.log('count', count);
     $("#"+formid).attr('data-times',count); // add 1 to update

     // console.log('enter state');
    if (count > 3) {
          alert("Sorry, no more than 3 attempts allowed.");
          return;
      }
        // window.open('','pwdwindow','left=20,top=20,width=320,height=480,toolbar=0,location=0,resizable=1');
        enterPassword(formid);

  }
    if ($(el).attr('value') === "Enter"){
      lastform.eData="Login";

    } else {
      lastform.eData=$(el).attr('value');

    }
    lastform.system=$(el).attr('data-system');
    // console.log('lastform', lastform);


}



function logit(event,data="") {

  if (data=="") data = navigator.userAgent;
  //alert(data);
  var div = document.getElementById('log');

  var d = new Date();
  var n = d.toISOString();

  var csvString = n + ',' + user + ',' + lastform.system + ',' + lastform.event + ','+ lastform.eData + "\n";

  newline = "<li>" + n + " || " + // date
  user +  " || " + // user
  lastform.system +  " || " + // which account
  lastform.event + " || " + // which event
  lastform.eData +  " || "; // data
  div.innerHTML += newline;

  // $("#"+lastform.id).ajaxSubmit({url: 'https://mvp.soft.carleton.ca/svp3008/logdata.php'});

  writeAction(csvString);

}

function writeAction(s){
    $.post("writeFileNew", { "string": s}, function(data, status){
      console.log(status);
    });
  }

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

var randomFixedInteger = function (length) {
    return Math.floor(Math.pow(10, length-1) + Math.random() * (Math.pow(10, length) - Math.pow(10, length-1) - 1));
}

function disform(n) {
    steps[n].style= "display:block;pointer-events:none;background-color: lightgray;";
    $("#" + steps[n].id + " :button").prop("disabled", true);
}


function enform(n) {
   steps[stepn].style= "display:block;pointer-events:all;background-color: lightgreen;";
    $("#" + steps[n].id + " :button").prop("disabled", false);
    divname = steps[n].id;
    formname =  divname.replace("svp", "form");
        

}


function nextstep(el) {
  // console.log('step', stepn);
  if (stepn >= 0) {

      var lastStep = $(el).prev().attr("data-password");

      if (lastStep == "") {
        alert("Sorry, step not completed. Please try again.");
        return;
      }
        disform(stepn);

  }
  stepn = stepn + 1;
  if (stepn < steps.length) enform(stepn);
  else {
  alert("All done: Thanks! See Log Data.");
  document.getElementById('log').style.display = 'block';

  }
}

</script>

</div></body>