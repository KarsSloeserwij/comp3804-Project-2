<!--

This file serves as our testing framework for the application


List of functions and what they do:
===================================
randomFixedInteger(length) - generates a random string of integers: used to generate a random integer set for the user

generate_random_string(string_length) - generates a random string of a given length: used to generate a random string for the user

mkenter(name) - this is used to randomly create the enter account passwords

createPassword(formid) - this is used to open the passwordShape window and will get the resulting data from that window to allow the user to go to the next section and to save the password inputted

enterPassword(formid) - this is used to open the passwordShape window and will get the resulting data from the window to allow the user to go the next section as well as check if the password inputted by the user is correct

poppwdwindow(formid, el) - this is used to control the create and enter password functions and is called from the onclick events of the buttons

logit(event,data="") - this is used to log the data to the bottom of the page and to the file

writeAction(s) - this is the function that calls the restful service to write to the log file

shuffle(array) - this is a randomizer used to randomly input the accounts in the enter section

disform(n) - this is used to disable the buttons when stepping through the testing framework

enform(n) - this is used to enable the buttons when stepping through the testing framework

nextstep(el) - this is the main function that controls the next step functions enform and disform

-->
<html>

<style>

.highlighted{
  display: block; pointer-events: all; background-color: lightgreen;
}

.not-highlighted{
  display:block;pointer-events:none;background-color: gray;
}

</style>
<head>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

</head>

<body>

<!-- HTML component, has the header with a randomized user-->
<div id="greeting"><h2> Password Tester</h2> <h3> User: <span id='userid'>Test</span></h3> <h3> Scheme: Panther scheme</h3><hr></div>


<!-- Creation for email -->

<div id="svpcEmail" style="display: block; pointer-events: all; background-color: lightgreen;">Create Password for: <b>Email</b>

    <input type="button" data-system="Email" value="Create" id="cEmail" data-password="" onclick="poppwdwindow('cEmail', this);">
    <input type="button" value="Next" onclick="nextstep(this)">

<!-- Creation for banking -->

</div><div id="svpcBanking" style="display:block;pointer-events:none;background-color: gray;">Create Password for: <b>Banking</b>

    <input type="button" data-system="Banking" disabled="" id="cBanking"  data-password="" value="Create" onclick="poppwdwindow('cBanking', this);">
    <input type="button" disabled="" value="Next" onclick="nextstep(this)">

<!-- Creation for shopping -->

</div><div id="svpcShopping" style="display:block;pointer-events:none;background-color: gray;">Create Password for: <b>Shopping</b>

    <input type="button" data-system="Shopping" disabled="" id="cShopping"  data-password="" value="Create" onclick="poppwdwindow('cShopping', this);">
    <input type="button" disabled="" value="Next" onclick="nextstep(this)">

</div>

<div><hr></div>

<!-- Entry randomized container -->
<div id="randomizeDiv">

</div>

<!-- Logging container -->
<div id="logdiv">

<hr>
<div id="logheader" style="display:none">
<h3>Show Activity Log:
    <input type="button" value="Show" onclick="document.getElementById('log').style.display = 'block';">
    <input type="button" value="Hide" onclick="document.getElementById('log').style.display = 'none';">
</h3>
</div>

<div id="log" style="display: block; pointer-events: all; background-color: lightgray;">
<h4>Log Data:</h4>
<hr>
</div>


<script>


var randomFixedInteger = function (length) {
    return Math.floor(Math.pow(10, length-1) + Math.random() * (Math.pow(10, length) - Math.pow(10, length-1) - 1));
}


function generate_random_string(string_length){
    let random_string = '';
    let random_ascii;
    for(let i = 0; i < string_length; i++) {
        random_ascii = Math.floor((Math.random() * 25) + 97);
        random_string += String.fromCharCode(random_ascii)
    }
    return random_string
}


var lastform = {
  event: "",
  eData: "",
  system: ""
}

var user = generate_random_string(5) + randomFixedInteger(3);
// do random user
$('#userid').text(user);

csys = ["Email","Banking","Shopping"];

newdiv = document.createElement('div');
newdiv.innerHTML = "<HR>";
document.body.appendChild(newdiv);

esys = shuffle(csys)
for (x of esys)
mkenter(x);


document.body.appendChild(document.getElementById("logdiv"));

steps = $('div[id^="svp"]');
stepn = -1;
nextstep();


function mkenter(name) {

  newdiv = document.createElement('div');
  dname = "form"+"e"+name;
  newdiv.setAttribute("id", "svpe" + name);
  newdiv.setAttribute("class", "not-highlighted");

  // html string for the entry account set
  var htmlString = '<input type="button" data-system="'+name+'" disabled="" id="e'+name+'" data-times="0" data-password="" value="Enter" onclick="poppwdwindow(\'e'+name+'\', this);">'+
    '<input type="button" disabled="" value="Next" onclick="nextstep(this)">';

  newdiv.innerHTML = "Enter Password for: <B>" + name + "</B> (3 Attempts Allowed)" + htmlString;
  // append element to randomize div 
  document.getElementById("randomizeDiv").appendChild(newdiv);
}

var globalPassword;
var openedWindow;
function createPassword(formid){
  var type = formid.substring(1,);

  // open window in the passwordshape with specific type param (which would be the account) for create
  openedWindow = window.open('/passwordShape?create=true&type='+type,'Create Password','left=20,top=20,width=500,height=550,toolbar=0,location=0,resizable=1');


  // add event listener so on close it will write back to the parent window
  openedWindow.addEventListener("beforeunload", function (e) {

    if (openedWindow.passwordAccept){
      $("#"+formid).attr('data-password',openedWindow.password);
      logit('Create');
    }
  });
}


function enterPassword(formid){
  var type = formid.substring(1,);

    // open window in the passwordshape with specific type param (which would be the account) for enter
  openedWindow = window.open('/passwordShape?enter=true&type='+type,'Enter Password','left=20,top=20,width=500,height=500,toolbar=0,location=0,resizable=1');


  var d = new Date();
  var n = d.toISOString();

  var csvString = n + ',' + user + ',' + lastform.system + ',' + "start" + ','+ "enter" + "\n";

  // write to log file
  writeAction(csvString);
  var div = document.getElementById('log');

  newline = "<li>" + n + " || " + // date
  user +  " || " + // user
  lastform.system +  " || " + // which account
  "start" + " || " + // which event
  "enter" +  " || "; // data
  div.innerHTML += newline;

 
    // add event listener so on close it will write back to the parent window
  openedWindow.addEventListener("beforeunload", function (e) {
    if (openedWindow.passwordAccept){
      $("#"+formid).attr('data-password',openedWindow.password);
      lastform.event=openedWindow.eventType;
      logit('login');
    }
  });

}





function poppwdwindow(formid, el) {
  f= $(el).val();

  if (f == "Create") {

    lastform.event="Create account"

    createPassword(formid);
  } else if (f == "Enter"){
    // data attribute for password
    // iterate counts
    var count = parseInt($("#"+formid).attr('data-times')) + 1;
     $("#"+formid).attr('data-times',count); // add 1 to update

     // console.log('enter state');

     // only let them have 3 attemps
    if (count > 3) {
          alert("Sorry, no more than 3 attempts allowed.");
          return;
      }
        enterPassword(formid);

  }
    if ($(el).attr('value') === "Enter"){
      lastform.eData="login";

    } else {
      lastform.eData=$(el).attr('value').toLowerCase();

    }
    lastform.system=$(el).attr('data-system');


}




function logit(event,data="") {

  if (data=="") data = navigator.userAgent;
  //alert(data);
  var div = document.getElementById('log');

  var d = new Date();
  var n = d.toISOString();
  lastform.data = data;
  
  var csvString = n + ',' + user + ',' + lastform.system + ',' + lastform.event + ','+ lastform.eData + ',' + data + "\n";

  // write to bottom of page
  newline = "<li>" + n + " || " + // date
  user +  " || " + // user
  lastform.system +  " || " + // which account
  lastform.event + " || " + // which event
  lastform.eData +  " || " +
  lastform.data; // data
  div.innerHTML += newline;


  // write to log file
  writeAction(csvString);

}


function writeAction(s){
    $.post("writeFileNew", { "string": s}, function(data, status){
      console.log(status);
    });
  }

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}


function disform(n) {
    steps[n].style= "display:block;pointer-events:none;background-color: lightgray;";
    // disable step at this id
    $("#" + steps[n].id + " :button").prop("disabled", true);
}


function enform(n) {
   steps[stepn].style= "display:block;pointer-events:all;background-color: lightgreen;";
   // enable step at this id
    $("#" + steps[n].id + " :button").prop("disabled", false);
    divname = steps[n].id;
    formname =  divname.replace("svp", "form");
        

}


function nextstep(el) {
  if (stepn >= 0) {

      var lastStep = $(el).prev().attr("data-password");

      // will check if last step has been done yet
      if (lastStep == "") {
        alert("Sorry, step not completed. Please try again.");
        return;
      }
        disform(stepn);

  }
  stepn = stepn + 1;
  if (stepn < steps.length) enform(stepn);
  else {
  alert("All done: Thanks! See Log Data.");
  document.getElementById('log').style.display = 'block';

  }
}

</script>

</div></body>
